{"remainingRequest":"/home/neuron/build/html5/node_modules/babel-loader/lib/index.js!/home/neuron/build/html5/node_modules/@vue/cli-plugin-eslint/node_modules/eslint-loader/index.js??ref--13-0!/home/neuron/build/html5/src/plugin/ws/DataSource.js","dependencies":[{"path":"/home/neuron/build/html5/src/plugin/ws/DataSource.js","mtime":1586417712650},{"path":"/home/neuron/build/html5/node_modules/cache-loader/dist/cjs.js","mtime":1578022549920},{"path":"/home/neuron/build/html5/node_modules/babel-loader/lib/index.js","mtime":1578022512688},{"path":"/home/neuron/build/html5/node_modules/@vue/cli-plugin-eslint/node_modules/eslint-loader/index.js","mtime":1578022543487}],"contextDependencies":[],"result":["import \"core-js/modules/web.dom.iterable\";\nimport \"core-js/modules/es6.string.iterator\";\nimport \"core-js/modules/es6.set\";\nimport \"core-js/modules/es6.function.name\";\nimport _classCallCheck from \"/home/neuron/build/html5/node_modules/@babel/runtime-corejs2/helpers/esm/classCallCheck\";\nimport _createClass from \"/home/neuron/build/html5/node_modules/@babel/runtime-corejs2/helpers/esm/createClass\";\nimport Vue from 'vue';\nimport BaseConfig from \"./config.js\";\nimport { Message } from 'element-ui';\nvar dataSource;\n\nvar DataSource =\n/*#__PURE__*/\nfunction () {\n  function DataSource() {\n    var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n\n    _classCallCheck(this, DataSource);\n\n    var name = config.name,\n        pass = config.pass,\n        success = config.success;\n    var storage = JSON.parse(sessionStorage.getItem('user') || '{}');\n    this.wsUri = BaseConfig.serverBaseUrl;\n    this.websocket = null;\n    this.type = 'datathread'; // datathread\n\n    this.wtrm = 'DEMO-Neuron-1001_1532419775357_240';\n    this.name = name || storage.name;\n    this.pass = pass || storage.pass;\n    this.onsuccess = new Set();\n    this.tmp = null;\n    success && this.onsuccess.add(success);\n\n    this.onclose = function () {\n      Message.warning('socket closed');\n      console.log('socket closed');\n    };\n\n    this.onerror = function (e) {\n      Message.error('socket error');\n      console.log('socket error');\n      throw e;\n    };\n  }\n\n  _createClass(DataSource, [{\n    key: \"connect\",\n    value: function connect() {\n      var _this = this;\n\n      this.close();\n      return new Promise(function (resolve, reject) {\n        _this.websocket = new WebSocket(_this.wsUri, _this.type);\n\n        _this.websocket.addEventListener('open', function () {\n          var j = {\n            func: 10,\n            name: _this.name,\n            pass: _this.pass\n          };\n          var txt = JSON.stringify(j);\n\n          _this.websocket.send(txt);\n        });\n\n        _this.websocket.onclose = _this.onclose;\n        _this.websocket.onerror = _this.onerror;\n\n        _this.set({\n          success: function success(data) {\n            if (data.func === 10) {\n              if (data.errc) {\n                dataSource = null;\n              } else {\n                resolve({\n                  name: _this.name,\n                  pass: _this.pass\n                });\n              }\n            }\n          }\n        });\n      });\n    } // login (data) {\n    //   if (data.func === 10) {\n    //     this.remove(this.login)\n    //     console.log(data)\n    //   }\n    // }\n\n  }, {\n    key: \"close\",\n    value: function close() {\n      if (this.websocket) {\n        this.websocket.close();\n        this.websocket = null;\n        dataSource = null;\n      }\n    }\n  }, {\n    key: \"set\",\n    value: function set() {\n      var _this2 = this;\n\n      var config = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n      var success = config.success;\n      success && this.onsuccess.add(success);\n\n      if (this.websocket && success) {\n        this.websocket.onmessage = function (e) {\n          var data = e.data && JSON.parse(e.data);\n\n          _this2.onsuccess.forEach(function (i) {\n            if (!data.wtrm || data.wtrm === _this2.wtrm) {\n              if (data.errc) Message.error(data.emsg);\n              i(data);\n            }\n          });\n        };\n      }\n\n      return this;\n    }\n  }, {\n    key: \"remove\",\n    value: function remove(func) {\n      this.onsuccess.delete(func);\n    }\n  }, {\n    key: \"send\",\n    value: function send(msg) {\n      var _this3 = this;\n\n      if (msg) {\n        msg.wtrm = this.wtrm;\n\n        if (typeof msg !== 'string') {\n          msg = JSON.stringify(msg);\n        }\n\n        this.tmp = function () {\n          return _this3.websocket.send(msg);\n        };\n      }\n\n      if (this.websocket && this.websocket.readyState !== 1) {\n        if (this.tmp) {\n          setTimeout(function () {\n            _this3.send();\n          }, 200);\n        }\n      } else if (this.websocket) {\n        this.tmp && this.tmp();\n        this.tmp = null;\n      }\n    }\n  }, {\n    key: \"test\",\n    value: function test() {\n      if (!this.websocket) {\n        this.connect();\n      }\n\n      return this;\n    }\n  }]);\n\n  return DataSource;\n}();\n\nVue.prototype.$ws = function getDataSource(config) {\n  if (!dataSource) {\n    dataSource = new DataSource(config);\n  } else {\n    if (config) dataSource.set(config);\n  }\n\n  return dataSource;\n};\n\nVue.prototype.$dataSource = dataSource;",{"version":3,"sources":["/home/neuron/build/html5/src/plugin/ws/DataSource.js"],"names":["Vue","BaseConfig","Message","dataSource","DataSource","config","name","pass","success","storage","JSON","parse","sessionStorage","getItem","wsUri","serverBaseUrl","websocket","type","wtrm","onsuccess","Set","tmp","add","onclose","warning","console","log","onerror","e","error","close","Promise","resolve","reject","WebSocket","addEventListener","j","func","txt","stringify","send","set","data","errc","onmessage","forEach","i","emsg","delete","msg","readyState","setTimeout","connect","prototype","$ws","getDataSource","$dataSource"],"mappings":"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","sourcesContent":["import Vue from 'vue'\nimport BaseConfig from './config.js'\nimport {\n  Message\n} from 'element-ui'\nlet dataSource\n\nclass DataSource {\n  constructor (config = {}) {\n    const {\n      name,\n      pass,\n      success\n    } = config\n    const storage = JSON.parse(sessionStorage.getItem('user') || '{}')\n    this.wsUri = BaseConfig.serverBaseUrl\n    this.websocket = null\n    this.type = 'datathread' // datathread\n    this.wtrm = 'DEMO-Neuron-1001_1532419775357_240'\n    this.name = name || storage.name\n    this.pass = pass || storage.pass\n    this.onsuccess = new Set()\n    this.tmp = null\n    success && this.onsuccess.add(success)\n    this.onclose = () => {\n      Message.warning('socket closed')\n      console.log('socket closed')\n    }\n    this.onerror = (e) => {\n      Message.error('socket error')\n      console.log('socket error')\n      throw e\n    }\n  }\n  connect () {\n    this.close()\n\n    return new Promise((resolve, reject) => {\n      this.websocket = new WebSocket(this.wsUri, this.type)\n      this.websocket.addEventListener('open', () => {\n        var j = {\n          func: 10,\n          name: this.name,\n          pass: this.pass\n        }\n        var txt = JSON.stringify(j)\n        this.websocket.send(txt)\n      })\n      this.websocket.onclose = this.onclose\n      this.websocket.onerror = this.onerror\n      this.set({\n        success: (data) => {\n          if (data.func === 10) {\n            if (data.errc) {\n              dataSource = null\n            } else {\n              resolve({\n                name: this.name,\n                pass: this.pass\n              })\n            }\n          }\n        }\n      })\n    })\n  }\n  // login (data) {\n  //   if (data.func === 10) {\n  //     this.remove(this.login)\n  //     console.log(data)\n  //   }\n  // }\n  close () {\n    if (this.websocket) {\n      this.websocket.close()\n      this.websocket = null\n      dataSource = null\n    }\n  }\n  set (config = {}) {\n    const {\n      success\n    } = config\n\n    success && this.onsuccess.add(success)\n\n    if (this.websocket && success) {\n      this.websocket.onmessage = (e) => {\n        const data = e.data && JSON.parse(e.data)\n        this.onsuccess.forEach(i => {\n          if (!data.wtrm || (data.wtrm === this.wtrm)) {\n            if (data.errc) Message.error(data.emsg)\n            i(data)\n          }\n        })\n      }\n    }\n\n    return this\n  }\n  remove (func) {\n    this.onsuccess.delete(func)\n  }\n  send (msg) {\n    if (msg) {\n      msg.wtrm = this.wtrm\n      if (typeof msg !== 'string') {\n        msg = JSON.stringify(msg)\n      }\n      this.tmp = () => this.websocket.send(msg)\n    }\n    if (this.websocket && this.websocket.readyState !== 1) {\n      if (this.tmp) {\n        setTimeout(() => {\n          this.send()\n        }, 200)\n      }\n    } else if (this.websocket) {\n      this.tmp && this.tmp()\n      this.tmp = null\n    }\n  }\n  test () {\n    if (!this.websocket) {\n      this.connect()\n    }\n    return this\n  }\n}\n\nVue.prototype.$ws = function getDataSource (config) {\n  if (!dataSource) {\n    dataSource = new DataSource(config)\n  } else {\n    if (config) dataSource.set(config)\n  }\n  return dataSource\n}\n\nVue.prototype.$dataSource = dataSource\n"]}]}